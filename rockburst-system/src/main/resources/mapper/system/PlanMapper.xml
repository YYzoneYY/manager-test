<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.PlanMapper">

    <select id="queryPage" resultType="com.ruoyi.system.domain.vo.PlanVO">
        select distinct
            p.plan_id as planId,
            p.annual as annual,
            p.monthly as monthly,
            p.workface_id as workFaceId,
            p.plan_type as planType,
            p.type as type,
            p.drill_type as drillType,
            p.plan_name as planName,
            p.total_drill_number as totalDrillNumber,
            p.total_hole_depth as totalHoleDepth,
            p.start_time as startTime,
            p.end_time as endTime,
            p.state as state,
            p.create_by as createBy,
            p.dept_id as deptId,
            p.del_flag as delFlag
        from plan as p
        <where>
            <if test="selectNewPlanDTO.annual != null and selectNewPlanDTO.annual != ''">
                and p.annual = #{selectNewPlanDTO.annual}
            </if>
            <if test="selectNewPlanDTO.type != null and selectNewPlanDTO.type != ''">
                and p.type = #{selectNewPlanDTO.type}
            </if>
            <if test="selectNewPlanDTO.drillType != null and selectNewPlanDTO.drillType != ''">
                and p.drill_type = #{selectNewPlanDTO.drillType}
            </if>
            <if test="selectNewPlanDTO.state != null and selectNewPlanDTO.state != ''">
                and p.state = #{selectNewPlanDTO.state}
            </if>
            <if test="selectNewPlanDTO.startTime != null and selectNewPlanDTO.startTime != ''">
                and p.start_time &gt;= #{selectNewPlanDTO.startTime}
            </if>
            <if test="selectNewPlanDTO.endTime != null and selectNewPlanDTO.endTime != ''">
                and p.end_time &lt;= #{selectNewPlanDTO.endTime}
            </if>
            <if test="deptIds != null and !deptIds.isEmpty() or dateScopeSelf == 5">
                <choose>
                    <when test="deptIds != null and deptIds.size() > 0">
                        <trim prefix="and (" suffix=")">
                            p.dept_id in
                            <foreach collection="deptIds" item="deptId" index="index" open="(" close=")" separator=",">
                                #{deptId}
                            </foreach>
                            <if test="dateScopeSelf == 5">
                                or p.create_by = #{userName}
                            </if>
                        </trim>
                    </when>
                    <when test="dateScopeSelf == 5">
                        p.create_by = #{userName}
                    </when>
                </choose>
            </if>
            and p.del_flag = '0'
        </where>
        order by p.create_time desc
    </select>

    <select id="queryPlanCount" resultType="com.ruoyi.system.domain.dto.largeScreen.PlanCountDTO">
        select p.monthly as monthly,
               group_count(p.plan_id) as planIds
        from plan as p
        where del_flag = '0'
        group by p.monthly
    </select>

</mapper>