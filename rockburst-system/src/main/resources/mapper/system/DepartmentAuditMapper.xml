<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.DepartmentAuditMapper">

    <!--获取同一工程填报，最大的审核次数-->
    <select id="selectMaxNumber" resultType="java.lang.Integer">
        select ifnull(max(number), 0)
        from department_audit as da
        where da.project_id = #{projectId} and da.del_flag = '0'
    </select>

    <select id="queryByPage" resultType="com.ruoyi.system.domain.vo.ProjectVO">
        select
        bpr.project_id as projectId,
        bpr.construct_type as constructType,
        bpr.drill_type as drillType,
        bpr.construct_unit_id as constructUnitId,
        bpr.construct_time as constructTime,
        bpr.location_id as constructSiteId,
        bpr.drill_num as drillNum,
        bpr.create_time as createTime,
        bpr.status as status,
        bpr.del_flag as delFlag
        from biz_project_record as bpr
        inner join team_audit as ta on bpr.project_id = ta.project_id
        <where>
            <if test="selectDeptAuditDTO.type != null and selectDeptAuditDTO.type != ''">
                and bpr.construct_type = #{selectDeptAuditDTO.constructType}
            </if>
            <if test="selectDeptAuditDTO.constructSite != null and selectDeptAuditDTO.constructSite != ''">
                and bpr.location_id = #{selectDeptAuditDTO.constructSite}
            </if>
            <if test="selectDeptAuditDTO.constructionUnitId != null and selectDeptAuditDTO.constructionUnitId != ''">
                and bpr.construct_unit_id = #{selectDeptAuditDTO.constructUnitId}
            </if>
            <if test="selectDeptAuditDTO.fillingType != null and selectDeptAuditDTO.fillingType != ''">
                and bpr.drill_type = #{selectDeptAuditDTO.fillingType}
            </if>
            <if test="selectDeptAuditDTO.startTime != null and selectDeptAuditDTO.endTime != null">
                and bpr.construct_time between #{selectDeptAuditDTO.startTime} and #{selectDeptAuditDTO.endTime}
            </if>
            <if test="projectIds != null and !projectIds.isEmpty()">
                and bpr.project_id in
                <foreach collection="projectIds" item="projectId" index="index" open="(" close=")" separator="," >
                    #{projectId}
                </foreach>
            </if>
            and bpr.del_flag = '0' and ta.audit_result = '1'
        </where>
        order by bpr.construct_time desc
    </select>

    <!--审核历史分页查询-->
    <select id="auditHistoryPage" parameterType="com.ruoyi.system.domain.dto.SelectProjectDTO"
            resultType="com.ruoyi.system.domain.vo.ProjectVO">
        select
        bpr.project_id as projectId,
        bpr.construct_type as constructType,
        bpr.drill_type as drillType,
        bpr.construct_unit_id as constructUnitId,
        bpr.construct_time as constructTime,
        bpr.location_id as constructSiteId,
        bpr.drill_num as drillNum,
        bpr.status as status,
        bpr.create_time as createTime,
        bpr.del_flag as delFlag
        from biz_project_record as bpr
        <where>
            <if test="type != null and type != ''">
                and bpr.construct_type = #{constructType}
            </if>
            <if test="constructSite != null and constructSite != ''">
                and bpr.location_id = #{constructSite}
            </if>
            <if test="constructionUnitId != null and constructionUnitId != ''">
                and bpr.construct_unit_id = #{constructUnitId}
            </if>
            <if test="fillingType != null and fillingType != ''">
                and bpr.drill_type = #{fillingType}
            </if>
            <if test="state != null and state != ''">
                and bpr.status = #{state}
            </if>
            <if test="startTime != null and endTime != null">
                and bpr.construct_time between #{startTime} and #{endTime}
            </if>
            and bpr.status in (3,4) and p.del_flag = '0'
        </where>
        order by bpr.construct_time desc
    </select>
</mapper>