<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.RoofAbscissionMapper">

    <!--获取最大测点编码，tag = '1'-->
    <select id="selectMaxMeasureNum" resultType="java.lang.String">
        SELECT ifnull(max(measure_num), 0)
        FROM roof_abscission
        WHERE tag = '1'
          AND mine_id = #{mineId} AND del_flag = '0'
        ORDER BY SUBSTRING(measure_num, -4) DESC LIMIT 1;
    </select>

    <select id="selectQueryPage" resultType="com.ruoyi.system.domain.vo.RoofAbscissionVO">
        SELECT
        ra.roof_abscission_id AS roofAbscissionId,
        ra.measure_num AS measureNum,
        ra.survey_area_name AS surveyAreaName,
        ra.workface_id AS workFaceId,
        ra.tunnel_id AS tunnelId,
        ra.sensor_type AS sensorType,
        ra.sensor_location AS sensorLocation,
        ra.install_time AS installTime,
        ra.shallow_init_depth AS shallowInitDepth,
        ra.deep_init_depth AS deepInitDepth,
        ra.status AS status
        FROM roof_abscission ra
        <where>
            <if test="measureSelectDTO.surveyAreaName != null and measureSelectDTO.surveyAreaName != ''">
                AND ra.survey_area_name like concat('%',#{measureSelectDTO.surveyAreaName},'%')
            </if>
            <if test="measureSelectDTO.workFaceId != null and measureSelectDTO.workFaceId != ''">
                AND ra.workface_id = #{measureSelectDTO.workFaceId}
            </if>
            <if test="measureSelectDTO.status != null and measureSelectDTO.status != ''">
                AND ra.status = #{measureSelectDTO.status}
            </if>
            <if test="measureSelectDTO.startTime != null">
                AND ra.install_time &gt;= #{measureSelectDTO.startTime}
            </if>
            <if test="measureSelectDTO.endTime != null">
                AND ra.install_time &lt;= #{measureSelectDTO.endTime}
            </if>
            AND ra.mine_id = #{mineId} AND ra.del_flag = '0'
        </where>
        ORDER BY ra.install_time DESC
    </select>

    <select id="selectMeasureNumList" resultType="java.lang.String">
        SELECT measure_num
        FROM roof_abscission as ra
        <where>
            ra.mine_id = #{mineId} AND ra.del_flag = '0'
            <if test="surveyAreaName != null and surveyAreaName != ''">
                AND ra.survey_area_name like concat('%',#{surveyAreaName},'%')
            </if>
        </where>
    </select>

    <select id="selectParameterPage" resultType="com.ruoyi.system.domain.dto.actual.ParameterDTO">
        SELECT
        ra.roof_abscission_id AS dataId,
        ra.measure_num AS measureNum,
        ra.sensor_type AS sensorType,
        ra.sensor_location AS sensorLocation,
        ra.workface_id AS workFaceId
        FROM roof_abscission ra
        <where>
            ra.mine_id = #{mineId} AND ra.del_flag = '0'
            <if test="keyword != null and keyword != ''">
                AND (
                ra.sensor_location LIKE CONCAT('%', #{keyword}, '%')
                OR ra.workface_id IN (
                SELECT bw.workface_id
                FROM biz_workface bw
                WHERE bw.workface_name LIKE CONCAT('%', #{keyword}, '%')
                AND bw.del_flag = '0'
                AND bw.mine_id = #{mineId}
                )
                )
            </if>
        </where>
        ORDER BY ra.install_time DESC
    </select>


</mapper>